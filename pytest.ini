# ChatGPT Team Relay - pytest.ini
#
# Pytest config for the relay:
# - Discovers test_*.py
# - Configures asyncio for FastAPI/httpx tests
# - Injects a stable "test" environment via env= block
# - Registers an "integration" marker for tests that hit a real relay

[pytest]

# Discover all test_*.py anywhere in the repo
testpaths = .
python_files = test_*.py
addopts = -ra

# Async support for httpx / FastAPI tests
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# ----------------------------------------------------------------------
# Environment for tests
# ----------------------------------------------------------------------
# NOTE:
# - OPENAI_API_KEY here can be a dummy; tests that hit real OpenAI
#   should read from the real env instead.
# - OPENAI_API_BASE must NOT include /v1.
# - Models and feature flags should mirror local dev / Render as much
#   as possible so behavior is consistent.

env =
    APP_MODE=test
    ENVIRONMENT=test
    RELAY_NAME=ChatGPT Team Relay (pytest)

    # Make imports like "from app.main import app" work
    PYTHONPATH=.

    # OpenAI upstream
    OPENAI_API_BASE=https://api.openai.com
    OPENAI_API_KEY=dummy-test-key
    OPENAI_ORG_ID=
    OPENAI_ASSISTANTS_BETA=assistants=v2
    OPENAI_REALTIME_BETA=realtime=v1

    # Models for tests (Responses + Realtime)
    DEFAULT_MODEL=gpt-4o-mini
    REALTIME_MODEL=gpt-4o-realtime-preview

    # Relay behavior toggles
    RELAY_AUTH_ENABLED=true
    ENABLE_STREAM=true
    CHAIN_WAIT_MODE=sequential
    RELAY_TIMEOUT=120
    PROXY_TIMEOUT=120

    # Tools & schema – needed by tests hitting /v1/tools etc.
    TOOLS_MANIFEST=app/manifests/tools_manifest.json
    VALIDATION_SCHEMA_PATH=ChatGPT-API_reference_ground_truth-2025-10-29.pdf

    # Relay / Actions secrets – dummy values for tests
    RELAY_KEY=dummy-test-relay-key
    CHATGPT_ACTIONS_SECRET=dummy-test-actions-secret

# Logging – keep it informative but not too noisy
log_cli = true
log_cli_level = INFO
log_level = INFO
log_format = %(asctime)s [%(levelname)s] %(name)s - %(message)s

# Warnings – silence noisy, known-safe deprecations
filterwarnings =
    ignore:.*python_multipart.*:PendingDeprecationWarning

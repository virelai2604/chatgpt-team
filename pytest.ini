# ChatGPT Team Relay - pytest.ini
#
# Pytest config for the relay:
# - Discovers test_*.py
# - Configures asyncio for FastAPI/httpx tests
# - Injects a stable "test" environment via env= block
# - Registers an "integration" marker for tests that hit a real relay
#
# NOTE: The env= block below is read by the pytest-env plugin.
# If you do not install pytest-env, you must provide these env vars
# via your shell / CI instead.

[pytest]

# Discover all test_*.py anywhere in the repo
testpaths = .
python_files = test_*.py
addopts = -ra

# Async support for httpx / FastAPI tests
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# Optional markers
markers =
    integration: tests that hit a real relay / external OpenAI-compatible endpoint

# Stable environment for tests (requires pytest-env)
env =
    # App mode & environment
    APP_MODE=test
    ENVIRONMENT=test

    # Relay / OpenAI base URLs (NO trailing /v1 here for the relay itself)
    # Local relay default: uvicorn app.main:app --host 127.0.0.1 --port 8000
    OPENAI_API_BASE=http://127.0.0.1:8000
    BASE_URL=http://127.0.0.1:8000
    REST_BASE=http://127.0.0.1:8000

    # Base URL for the OpenAI Python SDK (must include /v1)
    OPENAI_BASE_URL=http://127.0.0.1:8000/v1

    # Default model alias used in health + app config
    DEFAULT_MODEL=gpt-4o-mini

    # Dummy OpenAI-style identifiers for tests
    OPENAI_API_KEY=dummy-test-openai-key
    OPENAI_ORG=dummy-test-org
    OPENAI_PROJECT_ID=chatgpt-team-e2e

    # Relay / tools configuration expected by tests
    TOOLS_MANIFEST=tools_manifest.yaml
    CHAIN_WAIT_MODE=sequential
    VALIDATION_SCHEMA_PATH=ChatGPT-API_reference_ground_truth-2025-10-29.pdf

    # Relay / Actions secrets – dummy values for tests
    RELAY_KEY=dummy-test-relay-key
    CHATGPT_ACTIONS_SECRET=dummy-test-actions-secret

# Logging – keep it informative but not too noisy
log_cli = true
log_cli_level = INFO
log_level = INFO
log_format = %(asctime)s [%(levelname)s] %(name)s - %(message)s

# Warnings – silence noisy, known-safe deprecations
filterwarnings =
    ignore:.*python_multipart.*:PendingDeprecationWarning

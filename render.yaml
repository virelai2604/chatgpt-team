# ==============================================================
# Render Service Manifest
# ChatGPT Team Relay â€” Ground Truth API v1.7
# SDK Targets:
#   - openai-python 2.8.0
#   - openai-node 6.9.0
# ==============================================================

services:
  - type: web
    name: chatgpt-team-relay
    runtime: python
    repo: https://github.com/virelai2604/chatgpt-team
    region: singapore
    plan: starter

    buildCommand: |
      pip install -r requirements.txt

    # Render injects $PORT automatically; we bind to it with uvicorn.
    startCommand: |
      uvicorn app.main:app --host 0.0.0.0 --port $PORT

    env: python
    branch: main
    autoDeploy: true

    # Render health check uses this path
    healthCheckPath: /v1/health

    envVars:
      # --- Runtime and Metadata ---
      - key: APP_MODE
        value: production
      - key: RELAY_NAME
        value: "ChatGPT Team Relay"
      - key: BIFL_VERSION
        value: v2.3.4-fp
      - key: ENVIRONMENT
        value: production
      - key: BUILD_DATE
        value: 2025-10-29
      - key: BUILD_CHANNEL
        value: stable

      # --- OpenAI Beta Flags ---
      - key: OPENAI_REALTIME_BETA
        value: realtime=v1
      - key: OPENAI_ASSISTANTS_BETA
        value: assistants=v2

      # --- Python Runtime ---
      # Pin to 3.12.x so pydantic-core has prebuilt wheels
      - key: PYTHON_VERSION
        value: 3.12.5

      # --- Networking ---
      # Render sets $PORT automatically; RELAY_HOST is used only by your own code.
      - key: RELAY_HOST
        value: 0.0.0.0
      - key: RELAY_TIMEOUT
        value: 120
      - key: PROXY_TIMEOUT
        value: 120

      # --- Upstream OpenAI API ---
      # NOTE: no /v1 suffix; paths like /v1/responses will be appended by the relay.
      - key: OPENAI_API_BASE
        value: https://api.openai.com

      # These are marked sync:false so you set them ONLY in the
      # Render dashboard, not in Git.
      - key: OPENAI_API_KEY
        sync: false          # set real value in Render dashboard
      - key: OPENAI_ORG_ID
        sync: false          # optional organization ID

      # --- Defaults ---
      - key: DEFAULT_MODEL
        value: gpt-4o-mini
      - key: ENABLE_STREAM
        value: true
      - key: TOOLS_MANIFEST
        value: app/manifests/tools_manifest.json
      - key: CHAIN_WAIT_MODE
        value: true

      # --- CORS Configuration ---
      - key: CORS_ALLOW_ORIGINS
        value: https://chat.openai.com,https://platform.openai.com
      - key: CORS_ALLOW_METHODS
        value: GET,POST,PUT,PATCH,DELETE,OPTIONS
      - key: CORS_ALLOW_HEADERS
        value: "*"

      # --- Logging ---
      - key: LOG_LEVEL
        value: info
      - key: LOG_FORMAT
        value: json
      - key: LOG_COLOR
        value: false

      # --- Validation Schema (API reference PDF) ---
      - key: VALIDATION_SCHEMA_PATH
        value: ChatGPT-API_reference_ground_truth-2025-10-29.pdf

      # --- ChatGPT Actions Secret (optional but recommended) ---
      # Set this in the Render dashboard; use the same value in ChatGPT Actions
      # as an Authorization: Bearer <secret> header when you decide to enforce it.
      - key: CHATGPT_ACTIONS_SECRET
        sync: false

    buildFilter:
      paths:
        - app/**
        - requirements.txt
        - render.yaml
        - .env

# ==============================================================
# Notes:
# - The OpenAI API key and organization ID are set manually in the
#   Render Environment, not in the repo.
# - Health checks hit /v1/health on the relay.
# - The relay exposes the stable OpenAI endpoint families used by the
#   Python 2.8.0 and Node 6.x SDKs:
#     /v1/responses
#     /v1/models
#     /v1/files
#     /v1/embeddings
#     /v1/vector_stores
#     /v1/realtime/sessions
#     /v1/tools
#     /v1/images/generations
#     /v1/videos
# - Legacy endpoints (e.g., classic Chat Completions) are not specially
#   wrapped; they are simply proxied upstream if an SDK calls them.
# ==============================================================
